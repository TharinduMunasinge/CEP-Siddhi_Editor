<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Intelligent Siddhi Editor</title>
    <style type="text/css" media="screen">
        body {
            overflow: hidden;
        }

        #editor {
            margin: 0;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>


<body>

<pre id="editor"></pre>





<script src="js/ace_editor/ace.js"></script>
<script src="js/ace_editor/ext-language_tools.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/prototype/1.7.2.0/prototype.js"></script>
<script src='../eventprocessor/js/client_side_Siddhi_parser/lib/require.js'></script>


<script>

    var antlr4 = require('../eventprocessor/js/client_side_Siddhi_parser/antlr4/index');
    var SiddhiQLGrammarLexer=require('../eventprocessor/js/client_side_Siddhi_parser/gen/SiddhiQLLexer');
    var SiddhiQLGrammarParser=require('../eventprocessor/js/client_side_Siddhi_parser/gen/SiddhiQLParser');
    var KeyPrinter=require('../eventprocessor/js/client_side_Siddhi_parser/gen/KeyPrinter');
    var langTools = ace.require("ace/ext/language_tools");
    var Range = ace.require("ace/range").Range

</script>



<!-- load ace -->

<script>

    editor = ace.edit("editor");
    window.queryEditor=editor;
    editor.save=function (){
        console.log("Saved");
    }
    editor.session.setMode("ace/mode/siddhi");
    editor.setTheme("ace/theme/tomorrow");
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true
    });
    editor.getSession().setUseWrapMode(true);
    editor.getSession().setTabSize(4);
    editor.getSession().setUseSoftTabs(true);
    editor.setShowFoldWidgets(true);
    editor.setBehavioursEnabled(true);
    editor.setHighlightSelectedWord(true);
    editor.setHighlightActiveLine(true);
    editor.setDisplayIndentGuides(true);
    editor.setShowPrintMargin(false);
    document.getElementById('editor').style.fontSize='18px';




    editor.commands.on("afterExec", function(e){
        if (e.command.name == "insertstring" && /^[\@.]$/.test(e.args)) {
            editor.execCommand("startAutocomplete");
        }
    });



/*
    var wordList=[ {"word":"be","freq":30,"score":300,"flags":"bc","syllables":"1"},
        {"word":"t","freq":28,"score":300,"flags":"c","syllables":"1"},
        {"word":"de","freq":27,"score":300,"flags":"c","syllables":"1"},
        {"word":"d","freq":26,"score":300,"flags":"c","syllables":"1"},
        {"word":"p","freq":26,"score":300,"flags":"c","syllables":"1"},
        {"word":"pp","freq":26,"score":300,"flags":"","syllables":"1"},
        {"word":"di","freq":23,"score":300,"flags":"c","syllables":"1"},
        {"word":"g","freq":23,"score":300,"flags":"c","syllables":"1"},
        {"word":"tea","freq":23,"score":300,"flags":"bc","syllables":"1"},
        {"word":"bee","freq":21,"score":300,"flags":"bc","syllables":"1"},
        {"word":"te","freq":21,"score":300,"flags":"c","syllables":"1"},
        {"word":"je","freq":20,"score":300,"flags":"c","syllables":"1"},
        {"word":"ti","freq":20,"score":300,"flags":"bc","syllables":"1"},
        {"word":"pea","freq":19,"score":300,"flags":"bc","syllables":"1"}];

    var rhymeCompleter = {
        getCompletions: function(editor, session, pos, prefix, callback) {
            if (prefix.length === 0) { callback(null, []); return }
            console.log(editor,session,pos,prefix,callback);
            callback(null, wordList.map(function(ea) {
                return {name: ea.word, value: ea.word, score: ea.score, meta: "rhyme"}
            }));
        }
    }

    langTools.addCompleter(rhymeCompleter);

*/






    var lastErrors=1;
    window.syntaxErrorList=[];
    window.semanticErrorList=[];
    var previousParserTree="";


    editor.getSession().on('change', function(e) {

        var position=editor.getCursorPosition();
        if(e.data.text=="\n"){
//            console.log(editor.getCursorPosition());

            for(var index=0;index<semanticErrorList.length;index++){
                if(semanticErrorList[index].row>position.row ||( semanticErrorList[index].row==position.row && position.column==0)){
                    semanticErrorList[index].row++;
                }
            }
        };

        //      console.log(e.data.text=="\b")
        if(e.data.action=="removeLines"){
            for(var index=0;index<semanticErrorList.length;index++){
                if(semanticErrorList[index].row>position.row ||( semanticErrorList[index].row==position.row && position.column==0)){
                    semanticErrorList[index].row--;
                }
            }
        };

        if(window.syntaxErrorList.length>0) {
            //   editor.session.clearAnnotations();
            window.syntaxErrorList.splice(0,window.syntaxErrorList.length);
        }



        var expression=editor.getValue();
        var  txt=new antlr4.InputStream(expression)
        var lexer = new SiddhiQLGrammarLexer.SiddhiQLLexer(txt);
        var tokens = new  antlr4.CommonTokenStream(lexer);
        var parser = new SiddhiQLGrammarParser.SiddhiQLParser(tokens);
        parser.buildParseTrees = true;
        var tree = parser.parse();


        editor.session.setAnnotations(combine(syntaxErrorList,semanticErrorList));



        window.EditorTable=[];
        var printer = new KeyPrinter.KeyPrinter();
        antlr4.tree.ParseTreeWalker.DEFAULT.walk(printer, tree);



        if(parser._syntaxErrors==0 && (previousParserTree!=tree.toStringTree(tree,parser)))
        {
            var query="";
            for(var i=0;i<window.EditorTable.length;i++) {
                query+=window.EditorTable[i].state+"  \n";
                validateQueries3(query,window.EditorTable[i].line,window.EditorTable[i].state);

            }
        }

        previousParserTree=tree.toStringTree(tree,parser);
        lastErrors=parser._syntaxErrors;
   });




</script>

<script src="../eventprocessor/js/create_execution_plan_helper.js"></script>

</body>
</html>
